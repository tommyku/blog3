<!DOCTYPE html><html lang="en"><head><meta charset="utf-8" /><meta content="width=device-width,initial-scale=1.0" name="viewport" /><meta content="My friend got hacked (by me) - Tommy Ku&#39;s Blog - Random thoughts, stories and tutorials of a web dev" name="title" /><meta content="Web developer Tommy Ku talks about his experience in work, learning and life." name="description" /><meta content="Tommy Ku" name="author" /><meta content="My friend got hacked (by me) - Tommy Ku&#39;s Blog - Random thoughts, stories and tutorials of a web dev" property="og:title" /><meta content="article" property="og:type" /><meta content="/assets/images/banner.jpg" property="og:image" /><link href="/assets/images/author.jpg" rel="icon" type="image/png" /><link href="/atom.xml" rel="alternate" title="Tommy Ku&#39;s Method Stub" type="application/atom+xml" /><link href="https://webmention.tkcom.workers.dev/" rel="webmention" /><title>My friend got hacked (by me) - Tommy Ku&#39;s Blog</title><link href="/style/gutenberg.css" rel="stylesheet" /><link href="/style/prism.css" rel="stylesheet" /><meta content="Nanoc 4.11.15" name="generator" /></head><body><header><h2 class="h-card"><img alt="Profile pic of Tommy Ku" class="author u-photo" src="/assets/images/author.jpg" /><span class="p-name">Tommy Ku</span>'s Blog</h2><p><i>Reading and thinking</i></p></header><nav><a href="/">Index</a><a href="https://tommyku.com">About Me</a><a href="https://angel.co/tommyku">AngelList</a><a href="https://www.linkedin.com/in/tommy-chun-kit-ku-65aba999">LinkedIn</a><a rel="me" href="https://github.com/tommyku">GitHub</a><a href="/atom.xml">Feed</a></nav><main class="h-entry" id="main"><section id="meta"><h1 class="p-name">My friend got hacked (by me)</h1><i>Posted on&nbsp;<time class="dt-published" datetime="2014-01-27T00:00:00+08:00">January 27, 2014</time>&nbsp;by&nbsp;<span class="p-author">Tommy Ku</span></i><section id="old"><span class="icon">&#9888;</span><p>This post is more than 2 years old, it may contain outdated information</p></section></section><section class="e-content" id="content"><h2 id="background">Background</h2>

<p>Paying one month-worth of deligence, my friend got his first online service <a href="http://keansh.com/evaplus/">Evaplus</a> onlne (looks like it’s offline as of Aug 2016). He initially started with Mongodb and node.js but end up using PHP and MySQL. Fair, as PHP is easier for a newbie.</p>

<p>Despite, eventually, it went terribly wrong.</p>

<h2 id="the-hacking-bit">The hacking bit</h2>

<p>Evaplus collects the course evaluation results submitted by students in past years and present them in a fancier way. The client side webpage send a POST request to server by AJAX, then the server throws back any data needed.</p>

<p>AJAX, getting resource from server without refreshing the page. The evil lies not on AJAX but what were passed with AJAX. When user makes a query via his interface, the following data were sent to a PHP script via HTTP POST.</p>

<pre><code class="language-sql">yr[]: 2013
sem[]: s
school[]: engineering
order: DESC
type: course
limit: 10
catalog: `course` REGEXP ' ([1-4]|[A-Z])'
</code></pre>

<p>Doesn’t it look familiar? Remember he used MySQL database and PHP, I will show you the relationship very soon.</p>

<p>Server returns some good stuff such as the desired data and a line of SQL query string.</p>

<pre><code class="language-javascript">{
  sql: “SELECT * FROM `engineering` WHERE (`yr`=2013) AND (`sem`='f') AND (`instructor`=’’) AND (`lecture`=’’ AND `ecourse` REGEXP ' ([1-4]|[A-Z])' ORDER BY `mean` DESC, `sd` ASC, `respRate` DESC LIMIT 0,20; ”,
  data: “...”
}
</code></pre>

<p>The developer was out of his mind. Who would include the SQL string in the reply for no reason? The client should be decoupled from the server structure. Best case scenario the client side don’t even know what server side script / database was being used.</p>

<p>I reached the developer, and told him about that. Before he tried to understand what I was talking about, one of the tables got deleted. Totally shocked, he asked “how was it even possible?”</p>

<p><strong>SQL injection</strong></p>

<p>Look at the POST request again, it is not difficult to guess how the SQL query string was constructed. To put it simply, the developer only concatenate whatever was passed. Thus exploiting this property, additional SQL can be injected into the query string. The attacker will then have <em>almost</em> full control to the database.</p>

<p>Only that was not enough. Without knowledge concerning the internal structure of the table, it is hard to guess what the structure of the database is. In particular, the name of the table I want to modify and the structure of the record.</p>

<p>Luckily, the developer had everything printed in the SQL statement, making the database under the mercy of attackers.</p>

<p>I won’t reveal the details of the attacks because the above materials are enough for you to plan an attack. Eventually, I inserted records, deleted records, updated records, truncated table and deleted table under the developer’s consent.</p>

<h2 id="suggestions">Suggestions</h2>

<p>Evaplus is a well thought service to integrate the course evaluation results across over 10 years into a single place. Interface looks practical and responsive with bootstrap framework.</p>

<p>However, the aforementioned flaw should be fixed to prevent further attack which may used to forge records and even take down the service.</p>

<p>Here are some suggestions to improve security and performance of Evaplus.</p>

<h4 id="use-flat-file-database">Use flat file database####</h4>

<p>Considering the data stored are totally static, SQL database is unnecessary and insecure. The developer can put the records into files and filter the records with little complication. This avoids any sort of SQL injection attack.</p>

<h4 id="go-restful">Go RESTful####</h4>

<p>In addition, static data are even better fit with RESTful structure in which resources are available given the URIs. This would simplify the system and allow for decoupling the front end and back end. <a href="http://www.restapitutorial.com/">more about RESTful</a></p>

<h4 id="return-only-data">Return only data####</h4>

<p>Currenly the server returns rendered data, which means data are wrapped inside HTML representations when returned. By returning data in say, XML or JSON format, then package them into HTML in client side instead, it saves bandwidth and server load.</p>
</section><section id="suggestions"><h2>You could also look at...</h2><ul id="article-list"><li><a href="../a-self-hosting-lifecycle/">A self-hosting lifecycle</a><p class="abstract">How is it like to self-host something? This post describes the process of self-hosting from the initial thought process, to patching and housekeeping, all the way to the end-of-life of a self-hosted service</p></li><li><a href="../using-laravel-resource-controller-with-angularjs-ngresource/">Using Laravel resource controller with AngularJS ngResource</a><p class="abstract">An example of a RESTful API-based web app using Laravel 4.2 resource controller and AngularJS 1.4 NgResource</p></li><li><a href="../using-google-form-to-track-my-life-a-lifelogging-primer/">Using Google Form to track my life: a lifelogging primer</a><p class="abstract">Not only Google can track your every move, now you can track your own life using what Google is offering for free, and for your own good</p></li></ul></section><p>This post first appeared on&nbsp;<a class="u-url" href="https://blog.tommyku.com/blog/my-friend-got-hacked-by-me-/" id="permalink">Tommy Ku&#39;s blog</a>. Permalink: <a class="u-url" href="https://blog.tommyku.com/blog/my-friend-got-hacked-by-me-/" id="permalink">https://blog.tommyku.com/blog/my-friend-got-hacked-by-me-/</a></p><h2>About the author</h2><section class="h-card" id="bio"><img alt="Profile pic of Tommy Ku" class="u-photo" src="/assets/images/author.jpg" /><section class="p-note"><p><i><span class="p-author">Tommy Ku</span>, a&nbsp;<span class="p-country-name">Hong Kong</span>-based&nbsp;<span class="p-job-title">Software Engineer</span>&nbsp;experienced developing PHP and Java-based web solutions and passionate in Web technology.</i></p><p><i>Also a hobbyist digital and film photographer.</i></p></section></section></main><script src="/js/prism.js" type="text/javascript"></script><div id="disqus_thread"></div><script>var disqus_config = function () {
  this.page.url = "https://blog.tommyku.com/blog/my-friend-got-hacked-by-me-/";
  this.page.identifier = "my-friend-got-hacked-by-me-";
};

(function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = '//methodstub.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();</script><noscript>Please enable JavaScript to view the <a ,="" href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><hr /><footer></footer><a class="unloaded" href="https://blog.tommyku.com/blog/website-analytics-for-lazy-people" id="tracking-status" title="I know you viewed this page"></a><img onload="javascript: document.querySelector(&#39;#tracking-status&#39;).classList.replace(&#39;unloaded&#39;, &#39;loaded&#39;)" src="https://blog-view.tkcom.workers.dev/?https://blog.tommyku.com/blog/my-friend-got-hacked-by-me-/" style="width: 0px; height: 0px; margin: 0; padding: 0; visibility: hidden;" /></body></html>